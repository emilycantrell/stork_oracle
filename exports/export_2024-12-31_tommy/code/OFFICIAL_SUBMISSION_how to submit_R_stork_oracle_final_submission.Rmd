---
title: "how to submit_R"
output: html_document
date: "2024-09-16"
---


## How to submit to intermediate/final leaderboard

1. Check if your code for preprocessing the data and training the model is reproducible (e.g. you set seed where necessary) and readable. Ideally, you should have a separate script for preprocessing the data (for everything not included into a pipeline), and for training & saving the model.  

2. Put all the files needed to make predictions and reproduce the submission into a separate subfolder in your team's folder - `H:\team_name\submission_name`:
    - scripts for preprocessing the data and training & saving the model 
    - the model itself
    - a copy of this script with edited `predict_outcomes` function for producing predictions
    - a short description of the model in any format (txt, rmd, pdf or other)
    - a file with preprocessed features for the holdout set (optional; here we assume that you'll start with a preprocessed file, but it's not necessary)

3. Edit the `predict_outcomes` function below to produce predictions for the holdout. For example, you might want to change the threshold for transforming predicted probabilities into 1s and 0s. You can also change the arguments.  

4. Apply this function to produce predictions for the intermediate leaderboard (people included in the `H:\DATASETS\holdout_intermediate_leaderboard.csv`) or (for final submissions) to the final leaderboard (people included in the `H:\DATASETS\holdout_final_leaderboard.csv`). 
    - Predictions should be saved as a csv file under your team name + submission name in the `H:/PREDICTIONS` folder, i.e. `H:/PREDICTIONS/team_name_submission_1.csv`. 
    - The csv file should have two columns, "RINPERSOON" (ID) and "prediction" (binary, 0 or 1).
    - There should be no missing values in the predictions.
    
5. Send an email to Lisa that you saved predictions.


## Update the `predict_outcomes` function

Please update the function below. By default it takes the path to the preprocessed data, path to the model, team name, and submission name.  

If your model produces probabilities by default, transform them into classes (1s and 0s) by specifiyng a threshold.    

Note that "RINPERSOON" should always be read as character column, otherwise the zeros in the beginning of ID will be lost.  


```{r}
#load necessary packages
library(data.table)
library(tidyverse)
library(tidymodels)
library(catboost)

predict_outcomes <- function(path_to_preprocessed_holdout_data, path_to_remove_zero_variance, model_path, path_to_results, team_name, submission_name){
  # read preprocessed holdout data 
  df <- readRDS(path_to_preprocessed_holdout_data)
  
  # read recipe object that removes columns with zero variance in the training set
  remove_zero_variance <- readRDS(path_to_remove_zero_variance)
  
  # additional preprocessing
  df <- bake(remove_zero_variance, df)
  pool <- select(df, -RINPERSOON) %>%
    catboost.load_pool()
  
  # load model
  model <- catboost.load_model(model_path)
  
  # generate predictions from the model
  predictions <- catboost.predict(model, pool, prediction_type = "Probability")
  
  # turn probabilities into predicted classes - adjust the threshold based on threshold from results.csv
  results <- fread(path_to_results)
  threshold <- results$threshold_F1_Score
  predictions <- ifelse(predictions >= threshold, 1, 0)
  
  # the output file should be a csv file with two columns: RINPERSOON and `prediction`
  df_predict <- data.frame("RINPERSOON" = df[, "RINPERSOON"], "prediction" = predictions)
  
  # write csv
  fwrite(df_predict, file = paste0("H:\\PREDICTIONS\\", team_name, submission_name, ".csv"))
}
```

## Apply function to produce predictions

```{r}
# produce predictions - change path to data, path to model, team name, submission name. Example:
predict_outcomes(path_to_preprocessed_holdout_data="H:/pmt/STORK_ORACLE_FINAL_PREFER_SUBMISSION_2024-10-28/code_to_create_preprocessed_holdout_data_for_final_submission_2024-10-28/preprocessed_holdout_data_for_stork_oracle_final_submission_2024-10-28.rds", 
                 path_to_remove_zero_variance = "H:/pmt/STORK_ORACLE_FINAL_PREFER_SUBMISSION_2024-10-28/from_ossc/remove_zero_variance.RDS",
                 model_path="H:/pmt/STORK_ORACLE_FINAL_PREFER_SUBMISSION_2024-10-28/from_ossc/all_plus_LiveInPartner_pmt_train_and_evaluation_samples_seed_1_241016.csv_training_and_evaluation_set_catboost_learning_rate=NA,subsample=0.8,depth=6", 
                 path_to_results="H:/pmt/STORK_ORACLE_FINAL_PREFER_SUBMISSION_2024-10-28/from_ossc/results.csv",
                 team_name="pmt_stork_oracle_", 
                 submission_name="final_submission_2024-10-28") 
```